'use strict';var adVideoPlayNow=true;var mainVideoPlayNow=false;var preroll=true;var pauseroll=false;var sbPressed=false;var adFirstStart=true;var sbp=false;var pauseNow=false;var progressEventsSeconds=[];var vmv=false;var vml=false;var vct=0;var isFullscreen=false;var videoAd=void 0;var player=void 0;var skipDelay=void 0;var vastTracker=void 0;var clickLink=void 0;var lv=function lv(vu){return new Promise(function(resolve,reject){DMVAST.client.get(vu,function(r,e){vastTracker=new DMVAST.tracker(r.ads[0],r.ads[0].creatives[0]);vastTracker.on('start',function(){return console.log(getCurrentDate()+' Ad event: start')});vastTracker.on('mute',function(){return console.log(getCurrentDate()+' Ad event: mute')});vastTracker.on('unmute',function(){return console.log(getCurrentDate()+' Ad event: unmute')});vastTracker.on('skip',function(){return console.log(getCurrentDate()+' Ad event: skip')});vastTracker.on('clickthrough',function(url){return console.log(getCurrentDate()+' Ad event: click')});vastTracker.on('complete',function(){return console.log(getCurrentDate()+' Ad event: complete')});vastTracker.on('firstQuartile',function(){return console.log(getCurrentDate()+' Ad event: firstQuartile')});vastTracker.on('midpoint',function(){return console.log(getCurrentDate()+' Ad event: midpoint')});vastTracker.on('thirdQuartile',function(){return console.log(getCurrentDate()+' Ad event: thirdQuartile')});vastTracker.on('fullscreen',function(){return console.log(getCurrentDate()+' Ad event: fullscreen')});vastTracker.on('exitFullscreen',function(){return console.log(getCurrentDate()+' Ad event: exitFullscreen')});for(var k in vastTracker.trackingEvents){var re=/progress-\d*/;if(!k.search(re)){progressEventsSeconds.push(parseInt(k.split('-')[1]))}}progressEventsSeconds.sort(function(a,b){return a-b});videoAd=r.ads[0].creatives[0].mediaFiles[0].fileURL;skipDelay=r.ads[0].creatives[0].skipDelay;clickLink=r.ads[0].creatives[0].videoClickThroughURLTemplate;resolve()})})};var fsEventOn=function fsEventOn(){player.on(Clappr.Events.PLAYER_FULLSCREEN,function(){isFullscreen=!isFullscreen;if(adVideoPlayNow){vastTracker.setFullscreen(isFullscreen)}})};var getCurrentDate=function getCurrentDate(){var d=new Date;return'('+d.getHours()+':'+d.getMinutes()+':'+d.getSeconds()+') '};var setTypeVideo=function setTypeVideo(type){if(type=='vod'){vmv=true}else if(type=='live'){vml=true}};var getVideoSource=function getVideoSource(){if(preroll){return videoAd}else if(pauseroll){return videoMain}};var setTypeAd=function setTypeAd(type){adVideoPlayNow=false;preroll=false;pauseroll=false;if(type=='preroll'){adVideoPlayNow=true;preroll=true}else if(type=='pauseroll'){pauseroll=true}};var _visibilityAPI=function(){var stateKey,eventKey,keys={hidden:'visibilitychange',webkitHidden:'webkitvisibilitychange',mozHidden:'mozvisibilitychange',msHidden:'msvisibilitychange'};for(stateKey in keys){if(stateKey in document){eventKey=keys[stateKey];break}}return{'setHandler':function setHandler(c){if(c)document.addEventListener(eventKey,c)},'tabVisible':function tabVisible(){return!document[stateKey]}}}();_visibilityAPI.setHandler(function(){if(adVideoPlayNow){if(_visibilityAPI.tabVisible()){setTimeout(function(){player.play()},300)}else{player.pause()}}});var clapprAdVastPlugin=Clappr.UIContainerPlugin.extend({name:'clappr-vast-ad-plugin',version:'2.0',adMuted:false,initialize:function initialize(){this.render();this.checkAdTime()},render:function render(){this.$el.css('font-size','20px');this.$el.css('position','absolute');this.$el.css('color','white');this.$el.css('top','70%');this.$el.css('right','0%');this.$el.css('background-color','black');this.$el.css('z-index','100500');this.$el.css('border','solid 3px #333333');this.$el.css('padding','5px');this.container.$el.append(this.$el);this.$el[0].id='adButton';if(preroll){this.show()}else if(pauseroll){if(adVideoPlayNow){this.show()}else{this.hide()}}return this},bindEvents:function bindEvents(){this.listenTo(this.container,Clappr.Events.CONTAINER_ENDED,this.containerEnded);this.listenTo(this.container,Clappr.Events.CONTAINER_PLAY,this.containerPlay);this.listenTo(this.container,Clappr.Events.CONTAINER_VOLUME,this.containerVolume);this.listenTo(this.container,Clappr.Events.CONTAINER_PAUSE,this.containerPause);this.listenTo(this.container,Clappr.Events.CONTAINER_CLICK,this.containerClick)},containerClick:function containerClick(){if(adVideoPlayNow){window.open(clickLink).focus();vastTracker.click()}else{player.pause()}},containerPause:function containerPause(){if(adVideoPlayNow&&!player.ended){vastTracker.setPaused(true)}else{player.pause();pauseNow=true}},containerVolume:function containerVolume(){if(adVideoPlayNow&&player){if(player.getVolume()==0&&!this.AdMuted||player.getVolume()!=0&&this.AdMuted){this.AdMuted=!this.AdMuted;vastTracker.setMuted(this.AdMuted)}}},containerPlay:function containerPlay(){mainVideoPlayNow?this.hide():null;player.core.mediaControl.container.settings.seekEnabled=!adVideoPlayNow;if(adVideoPlayNow){this.show();if(adFirstStart){vastTracker.setProgress(0.1);adFirstStart=false}else{vastTracker.setPaused(false)}}else{this.hide()}if(preroll){}else if(pauseroll){if(!adVideoPlayNow&&pauseNow&&player.isPlaying()){pauseNow=false;if(vmv){vct=player.getCurrentTime()}this.switchSource('va');this.show()}}},containerEnded:function containerEnded(){pauseNow=false;if(adVideoPlayNow){vastTracker.complete();this.switchSource('av')}else if(preroll){this.switchSource('va');adVideoPlayNow=true;player.pause()}},switchSource:function switchSource(type){if(player!=null){var f=void 0,s=void 0;if(type=='av'){adVideoPlayNow=false;f=videoAd;s=videoMain}else if(type=='va'){adVideoPlayNow=true;f=videoMain;s=videoAd}var el=player.core.getCurrentPlayback().el;el.src=s;!sbPressed?el.play():null;if(type=='av'&&vmv){player.seek(vct)}}},show:function show(){var _this=this;var showAdButton=function showAdButton(){_this.$el.show();var timerId=setInterval(function(){var ab=document.getElementById('adButton');ab.textContent='You can skip this ad in '+parseInt(skipDelay-player.getCurrentTime());if(player.getCurrentTime()>skipDelay){clearInterval(timerId);ab.onclick=function(){sbp=true;vastTracker.skip();sbPressed=true;_this.switchSource('av');sbPressed=false};ab.textContent='Skip Ad'}},300)};if(preroll){if(adVideoPlayNow){showAdButton()}else{this.hide()}}else if(pauseroll){showAdButton()}},hide:function hide(){this.$el.hide()},checkAdTime:function checkAdTime(){if(adVideoPlayNow){(function(){var fq=false,mp=false,tq=false;var timerId=setInterval(function(){if(sbp){clearInterval(timerId)}else{if(progressEventsSeconds.length&&player.getCurrentTime()>=progressEventsSeconds[0]){vastTracker.setProgress(progressEventsSeconds.shift());console.log(getCurrentDate()+' Ad event: progress')}if(player.getCurrentTime()>=player.getDuration()*0.25&&!fq){vastTracker.setProgress(player.getCurrentTime());fq=true}else if(player.getCurrentTime()>=player.getDuration()*0.5&&!mp){vastTracker.setProgress(player.getCurrentTime());mp=true}else if(player.getCurrentTime()>=player.getDuration()*0.75&&!tq){vastTracker.setProgress(player.getCurrentTime());tq=true;clearInterval(timerId)}}},300)})()}}});